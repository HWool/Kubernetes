# 1. Pod

Pod 특징.

Pod 안에는 하나의 독립적인 서비스를 운영할 수 있는 컨터이너가 있고, 그 컨테이너들은 서비스들이 연결될 수 있도록 Port를 가지고있다. 컨테이너는 Port를 하나 이상을 가질 수 있지만, Pod내에서 컨테이너들끼리 Port가 중복될 순 없다. 컨테이너들은 한 호스트로 묶여있다고 볼 수 있는데, 같은 Pod 안에 있는 컨테이너들은 포트번호를 통해 접근을 할 수가 있다.

pod가 생성될 때 고유한 ip 주소가 할당되는데, 이것은 쿠버네티스 클러스터 내에서만 생성된 ip를 통해 접근을 할 수 있다. 외부에서는 불가능하다.

ip는 pod가 삭제되고 생성될 때마다 변경된다.

label은 모든 오브젝트에 달 수가 있는데, Pod에서 가장 많이 사용한다.
사용하는 이유는 목적에 따라 오브젝트를 분류를 하고 그 분류된 오브젝트들만 따로 골라서 연결하기 위해서이다.

라벨의 구성은 key와 value가 한쌍이고, 한 파드에는 여러 개의 라벨을 달 수가 있다.

Node Schedule
pod는 결국 여러 노드중에 하나의 노드에 올라가야 하는데, 올라가는 방벙 중에는 직접 노드를 설정하거나, 쿠버네티스가 자동으로 지정해주는 방법이 있다.

직접선택
직접 선택을 할 때는 노드를 만들 때 라벨을 만들고, 파드에다 그 노드를 지정할 수 있다.

자동선택
노드에는 전체 사용할 수 있는 자원양이 있는데, 스케쥴러가 판단해서 파드에서 필요한 자원을 충족할 수 있는 노드를 선택한다.

이때 자원양을 지정해줘야 하는데, 지정을 안해주면 계속 자원을 끌어와서 사용하기 때문에 다른 파드들이 쓸 자원이 없어 다같이 죽을 수 있다.

<br>
<br>

# 2. Service

서비스는 자신의 클러스터 ip를 가지고 있다.
이 서비스를 파드에 연결하면 서비스의 ip를 가지고 접근할 수 있다.

Why? Pod에도 ip가 있는데, 왜 서비스의 ip를 가지고 접근을 할까  
Ans! Pod라는 존재는 언제든지 장애로 인해 죽을 수가 있고, 재생성이 될 수가 있는데, 이렇게 되면 ip가 변경된다. (신뢰성 떨어짐)
서비스의 ip는 사용자가 직접 지우지가 않는한 삭제되거나 재생성되지 않기 때문에, 서비스의 ip로 접근하면 항상 연결되어 있는 파드에 접근할 수 있다.

서비스의 종류는 여러가지가 있다.

## 2-1. ClusterIP

---

파드의 IP 특징과 같이 쿠버네티스 클러스터 내에서만 접근이 가능한 IP다.  
그렇기 때문에 클러스터 내의 다른 오브젝트들이 모두 접근이 가능하지만 외부에서는 접근이 불가능하다.

서비스에 파드를 여러 개를 붙일 수도 있는데, 이때 각 파드들에게 들어가는 트래픽을 서비스가 분산해서 전달해준다.

## 2-2. NodePort

---

노드포트 타입으로 만들어도 서비스에는 기본적으로 Cluster가 할당이 돼서 clusterIP 타입과 같은 기능이 포함되어 있고, 노드포트만의 특징은 모든 노드에 똑같은 포트를 할당이 된다.

외부에서 어떤 노드간 노드 ip의 포트로 접속을 하면 서비스로 연결이 된다. 서비스는 자신한테 연결되어 있는 파드에 트래픽을 전달한다.

> 파드가 있는 노드에만 포트가 할당되는 것이 아닌, 모든 노드에 포트가 할당되는 것이다.

IF ) A,B 노드에 파드가 하나씩 올라가져 있음.
A 노드에 접근을 하더라도 B 노드에 있는 파드한테 트래픽을 전달할 수가 있다.

But )
`externalTrafficPolicy: Local` 이라는 옵션을 지정해주면 A 노드에 접근을 하면 A에 있는 파드에만 트래픽을 전달할 수 있다.

## 2-3. Load Balancer

---

기본적으로 노드포트의 성격을 그대로 가지고 있고, 추가적으로 Loadbalancer가 생겨서 각각의 노드에 트래픽을 분산시켜준다.

하지만 Loadbalncer에 외부에서 접근을 하려면 IP가 있어야하는데, 플러그인이 필요하다.

<br>

## 각 서비스의 사용처

<br>

클러스터IP는 클러스터 내에서만 사용가능하기에, 이 IP에 접근을 할 수 있는 대상은 인가된 사용자(운영자)이고, 주된 작업은 쿠버네티스 대시보드를 관리를 하거나, 각 Pod의 서비스 상태를 디버깅하는 작업을 할 때 사용된다.

노드포트는 특징이 물리적인 호스트에 IP를 통해서 Pod에 접근을 할 수 있다는 건데, 대부분 호스트 IP는 보안적으로 내부망에서만 접근할 수 있게 네트워크를 구성하기 때문에, 이 노드포트는 클러스터 밖에 있지만, 그래도 내부망 안에서 접근을 해야될 때 쓰인다.
그리고 일시적인 외부 연동용으로도 사용되는데, 종종 포트포워딩을 해서 외부에서 내부 시스템에 연결을 할때 잠깐 사용한다.

실제적으로 외부에 서비스를 노출시킬려면 로드밸런서를 이용해야한다.

# 3. Volume

## 3-1. emptyDir

---

컨테이너들끼리 데이터를 공유하기 위해 볼륨을 사용하는데, 최초의 볼륨은 항상 비어있기 때문에 emptyDir라고 하는 것이다.

파드 안에서 생성되기 때문에 파드가 문제 생겨 재생성이 되면 없어진다. 그렇기 때문에 이 볼륨을 통해 사용하는 데이터는 일시적인 사용목적에 의한 데이터만 넣는 것이 좋다.

## 3-2. hostPath

---

(hostPath이기 때문에 파드가 올라가져 있는 노드의 path만 사용가능)
파드들이 올라가져 있는 노드의 path를 볼륨으로써 사용한다.
emptyDir가 다르게 Pod가 사라져도 데이터가 사라지지 않는다는 장점이 있다. 하지만, 파드가 재생성이 될 때 원래 포함되어 있던 노드에 생성된다는 보장이 없다. 그렇기 때문에 새 노드에서 원래있던 볼륨에 마운트를 해주면 되는데, 쿠버네티스가 지원해주지 않기 때문에 운영자가 직접 설정해줘야 한다. (이러한 방법은 권장하지 않는다.)

hostPath는 각각의 노드에는 각 노드 자신을 위해서 사용되는 파일이 있는데, (시스템, 여러 설정 파일 등) Pod 자신이 할당 되어 있는 호스트의 데이터를 읽거나 써야할 때 사용을 한다.

> 즉, Pod의 데이터를 저장을 하는 용도가 아니라 Node에 있는 데이터를 Pod에서 쓰기 위한 용도이다.

## 3-3. PVC/PV

---

- 파드에 영속성있는 볼륨을 제공하기 위한 기능이다.

볼륨의 형태는 Local도 있지만 외부에 있는 볼륨도 있다.  
이런 것들을 각각 Persistent Volume을 정의를 하고 연결을 한다.
파드는 PV에 바로 연결하지않고, PVC를 통해서 PV와 연결이 된다.
중간에 PVC를 두는 이유는, 쿠버네티스는 볼륨사용에 있어서 User와 Admin 영역을 나누었기 때문이다.

1. Admin이 PV정의
2. User가 PVC 생성
3. K8S가 PVC에 맞는 적절한 볼륨에 연결을 해줌.
   - 자동으로 연결해줄 때 yaml 파일에서 `capacity`,`accessModes`를 통해 판단하고 연결해준다.
4. Pod를 만들 때 그 PVC를 사용하면 된다.

# 4. ConfigMap, Secret

두 오브젝트를 사용해야하는 상황

<img src=./image/ConfigMap_Secret.PNG>

개발환경과 상용환경이 있다.
A라는 서비스가 있는데, 일반접근과 보안접근을 지원하고 있다.  
개발환경에는 보안접근을 해제할 수 있는 옵션이 있고, 보안접근을 한다면 접근 유저와 키를 세팅할 수도 있다.
이러한 서비스를 상용환경에 배포를 해야한다면, 옵션이 바뀌어야 할 것이다.

이러한 값들은 컨테이너 안에 있는 서비스 이미지에 들어있는 값이기에 내용을 바꾼다는 거는 개발과 상용환경에 컨테이너 이미지를 각각 관리를 해야한다는 의미이다.  
(적은 변화를 위해 이미지를 관리하는 건 너무 비효율적.)

그래서 이러한 환경에 따라 바뀌는 값들은 외부에서 결정하게 하는데, 이것을 도와주는 ConfigMap과 Secret이라는 오브젝트이다.

내가 분리해야되는 일반적인 함수들을 모아서 ConifMap을 만들고,
Key와 같이 보안적인 관리가 필요한 값을 모아서 Secret을 만든다.
그리고 파드 생성시에 도 오브젝트를 연결을 할 수가 있다.  
그렇기 때문에 이미지를 두 개 관리하는 것이 아닌, 하나의 이미지를 만들고 ConfigMap과 Secret을 연결해서 사용하면 된다.

## 4-1 사용 방법

---

<img src=./image/ConfigMap_Secret1.PNG>

<br>

ConfigMap과 Secret을 만들 때 데이터로 상수 또는 파일로 넣을 수 있다. 파일을 넣을 땐 환경변수가 아닌 볼륨을 마운트해서 사용할 수 있다.

## 4-1-1 상수

---

secret에 value를 넣을 때 base64 인코딩을 해야해서 넣어야 하는데, 이게 파드로 주입이 될때에는 디코딩이 되어 환경변수에선 원본 값이 보이게 된다.

secret에 보안적인 요소는 일반적인 오브젝트 값들은 쿠버네티스 db에 저장이 되는데, secret은 메모리에 저장이된다. 그리고 key value값을 lMByte만 넣을 수 있다.

## 4-1-2 파일

---

파일을 통으로 configmap에 넣을 수가 있는데, 파일 이름이 키가 되고, 안에 내용이 value가 된다.

## 4-1-3 파일(마운트)

---

파을을 configmap에 넣는 것은 똑같고, pod를 만들 대 컨테이너 안에 mount path를 정의를 하고 path안에 파일을 마운트할 수 있다.

두가지의 큰 차이점.

파드를 생성하고 나서 각각의 컨피그맵의 내용을 변경을 하면 어떻게 될까?

환경변수 방식은 한번 주입하면 끝이기 때문에, 컨피그맵의 데이터가 변해도 파드의 환경변수의 값은 변하지 않는다.(파드가 재성성 되어야 함)

마운트 방식은 원본이 변경되면, 파드도 변하게 된다.

# 5. Namespace, ResourceQuota, LimitRange

<img src=./image/object_5.PNG>

<b>사용해야하는 상황</b>

쿠버네티스 클러스터안에 Namespace가 여러 개 존재하는데, 하나의 NS가 많은 양의 자원을 쓰고 있다면, 다른 NS들은 사용하지 못할 것이다. 그렇기 때문에, ResourceQuota가 존재하는데, RQ는 NS 당 최대 하나 설정할 수 있고, 자원을 제한해주는 역할을 해준다.
또한, 이제 제한하는 자원의 크기를 정해줄 수도 있는데, 그것을 LimitRange라고 하고, 이것은 NS에만 달 수 있는 것이 아닌, 클러스터에도 달 수 있다.

## 5-1. Namespace
***

한 NS 안에는 같은 type의 오브젝트들은 이름이 중복될 수 없기 때문에 이름이 유일한 키역할을 할 수 있다.

다른 NS 안에 자원과 분리가 돼서 관리가 되기 때문에 NS1의 Pod라벨과 NS2의 Service의 selecter가 같아도 연결이 되지 않는다.

만약 NS를 지우게 되면 해당 NS에 있단 자원들도 다 지워지기 때문에 유의해야 한다.


## 5-2. ResourceQuota
***

NS 안에 자원 한계를 지정해주는 오브젝트인데, RQ를 할당한 NS의 POD들은 자원 스펙을 명시하지 않으면 만들어지지 않고, RQ에서 지정한 자원양보다 높은 스펙을 원하는 POD들은 만들어지지 않는다.

<img src=./image/object_5-2_rqtype.PNG>

제한 할 수 있는 자원과, 오브젝트들이다.    
오브젝트들은 k8s의 버전이 증가할 때마다 변경될 수 있으니 확인해야한다.

## 5-3. LimitRange
***

각각의 POD마다 NS 안에 들어올 수 있는지 자원을 체크해준다.

정의를 할 때, 최소, 최대, request 값과 limit 값의 비율을 따지는데,

<img src=./image/object_5-3_lroption.PNG>

위 그림을 보면 최소 1G, 최대 4G 이며,  request 값과 limit 값이 3배가 넘으면 안된다는 이미이다.

<img src=./image/object_5-3_lroption2.PNG>

defaultRequest와 default 옵션도 있는데, 이렇게 설정을 하면 pod에 스펙을 설정을 안해도 LR에 할당된 옵션으로 설정이 된다.

